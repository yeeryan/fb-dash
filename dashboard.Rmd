---
title: "fb-dash"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(ggplot2)
library(plyr)
library(dplyr)
library(plotly)
library(rjson)
library(maps)
library(Cairo)

#FB Data Locations for initial import
region_import <- "data/fb_region.csv"
age_import <- "data/fb_age.csv"
gender_import <- "data/fb_gender.csv"

source("src/data_import.R")

#Running data_import function to create tibbles
fb_region <- data_import(region_import)
fb_age <- data_import(age_import)
fb_gender<- data_import(gender_import)

```

Row 
------------------------------

### Region Overview

```{r, results = 'HIDE'}
us_states <- map_data("state")
us_map <- map_data("usa")
fb_region_low <- fb_region %>% 
  mutate(Region = tolower(Region)) %>% 
  mutate(Region=replace(Region, Region == "washington, district of columbia", "district of columbia")) %>% 
  rename(region = Region)

us_plot <- ggplot(data = us_map, mapping = aes(x = long, y = lat, group = group)) +
  coord_quickmap() +
  geom_polygon(color = "black", fill = "gray")
  theme_void() +
  guides(fill = FALSE)

region_map <- left_join(us_states, fb_region_low, by = "region")

fb_region_map <- us_plot +
  geom_polygon(data = region_map, aes(fill = Impressions), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_void()

fb_region_map + scale_fill_gradient(trans = "log10")

```

Row
-----------------------------
### Gender Audiences

```{r}
plot_ly(fb_gender, 
        x = ~Gender, 
        y = ~Reach, 
        type = "bar", 
        mode = "markers",
        visible = T) %>%
  add_trace(fb_age, y = ~Impressions, visible = F) %>%
  add_trace(fb_age, y = ~`CPC (All)`, visible = F) %>%
  add_trace(fb_age, y = ~`CTR (All)`, visible = F) %>% 
  layout(
    showlegend=FALSE,
    yaxis = list(title = "Metric"),
    updatemenus = list(
      list(
        y = 1,
        x = 1,
        buttons = list(
          list(method = "restyle",
               label = "Reach",
               args = list("visible", list(TRUE, FALSE, FALSE, FALSE))),
          list(method = "restyle",
               label = "Impressions",
               args = list("visible", list(FALSE, TRUE, FALSE, FALSE))),
          list(method = "rstyle",
               label = "CPC",
               args = list("visible", list(FALSE, FALSE, TRUE, FALSE))),
          list(method = "restyle",
               label = "CTR",
               args = list("visible", list(FALSE, FALSE, FALSE, TRUE)))
        ))))
```

### Age Audiences

```{r}
plot_ly(fb_age, 
        x = ~Age, 
        y = ~Reach, 
        type = "bar", 
        mode = "markers",
        visible = T) %>%
  add_trace(fb_age, y = ~Impressions, visible = F) %>%
  add_trace(fb_age, y = ~`CPC (All)`, visible = F) %>%
  add_trace(fb_age, y = ~`CTR (All)`, visible = F) %>% 
  layout(
    showlegend=FALSE,
    yaxis = list(title = "Metric"),
    updatemenus = list(
      list(
        y = 1,
        x = 1,
        buttons = list(
          list(method = "restyle",
               label = "Reach",
               args = list("visible", list(TRUE, FALSE, FALSE, FALSE))),
          list(method = "restyle",
               label = "Impressions",
               args = list("visible", list(FALSE, TRUE, FALSE, FALSE))),
          list(method = "rstyle",
               label = "CPC",
               args = list("visible", list(FALSE, FALSE, TRUE, FALSE))),
          list(method = "restyle",
               label = "CTR",
               args = list("visible", list(FALSE, FALSE, FALSE, TRUE)))
        ))))
```

